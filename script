#!/bin/bash

# color styling variables
blue=220
yellow=27
export FOREGROUND=$blue
export BORDER_FOREGROUND=$yellow
export GUM_CONFIRM_PROMPT_FOREGROUND=$blue
export GUM_CONFIRM_SELECTED_BACKGROUND=$yellow
export GUM_INPUT_PROMPT_FOREGROUND=$blue
export GUM_INPUT_CURSOR_FOREGROUND=$yellow
export GUM_CHOOSE_HEADER_FOREGROUND=$blue
export GUM_CHOOSE_SELECTED_FOREGROUND=$yellow
export GUM_CHOOSE_CURSOR_FOREGROUND=$yellow
VSCODE_PATH=$HOME/Documents

# checking if the user is root and ~/.local/bin is in PATH
if [ "$EUID" -eq 0 ]; then
	echo "Please do not run as root"
	exit 1
fi
[ -d "$HOME/.local/bin" ] || mkdir -p "$HOME/.local/bin"
if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
	export PATH="$HOME/.local/bin:$PATH"
fi
# TEMP_DIR=$(echo testing)
# mkdir $TEMP_DIR
# Create a temporary directory and enter into it
TEMP_DIR=$(mktemp -d)
if [ ! -d "$TEMP_DIR" ]; then
	echo "Failed to create temp directory, going home"
	cd ~
else
	cd $TEMP_DIR
fi

if ! command -v gum &> /dev/null; then
	echo "Downloading gum..."
	wget -q --show-progress https://github.com/charmbracelet/gum/releases/download/v0.14.5/gum_0.14.5_Linux_x86_64.tar.gz
	tar -xzf gum_0.14.5_Linux_x86_64.tar.gz
	mv gum_0.14.5_Linux_x86_64/gum $HOME/.local/bin
	rm -rf gum_0.14.5_Linux_x86_64.tar.gz gum_0.14.5_Linux_x86_64
fi

gum style --bold --width 40 --border double --padding "1 2" --align center "Welcome to the Linux setup script! by andrexandre"
gum style --bold --foreground 0 "This script may not work with bash as default shell"

verify_installed_stuff() {
	gum confirm "Do you have root privileges?" && ROOT='y' || ROOT='n'
	cmds=("zsh" "git")
	for cmd in "${cmds[@]}"; do
		if command -v $cmd &> /dev/null; then
			echo -e "✅ $cmd is installed"
		else
			echo -e "❌ $cmd isn't installed"
		fi
	done
	if ([ "$ROOT" = 'y' ] && command -v code &> /dev/null) ||
		([ "$ROOT" = 'n' ] && [ -d $VSCODE_PATH/vscode ]); then
		echo -e "✅ code is installed"
	else
		echo -e "❌ code isn't installed"
	fi
	if [ -f $HOME/.zshrc ]; then
		if grep -q "My custom aliases" $HOME/.zshrc; then
			echo -e "✅ aliases are added"
		else
			echo -e "❌ aliases aren't added"
		fi
	else
		echo -e "❌ there's no .zshrc file"
	fi
}
install_command() {
	if [ -z "$1" ]; then
		set -- "$(gum input --placeholder "Enter the program to install:")"
		if [ -z "$1" ]; then
			return
		fi
	fi
	if ! command -v $1 &> /dev/null; then
		if ! apt-cache policy $1 | grep -q 'Installed: (none)'; then
			echo "The package $1 doesn't exist"
			return 1
		fi
		if [ "$ROOT" = 'y' ]; then
			sudo apt-get install -y $1
		else
			gum confirm "Are you sure you want to install a program without root?" && true || return
			apt-get download $1
			dpkg -x $1*.deb /tmp/command
			rm $1*.deb
			cp /tmp/command/usr/bin/$1 $HOME/.local/bin
			rm -rf /tmp/command
		fi
	else
		echo "$1 is already installed"
	fi
}
# Configurating extensions
install_gnome_extensions() {
	# sudo apt-get install chrome-gnome-shell # needed to install extensions
	# sudo apt-get install gnome-shell-extensions # maybe it is the extensions manager gui, idk
	# sudo apt-get install gnome-shell-extension-manager # for sure it is the extensions manager
	if [ ! -f $HOME/snap/firefox/common/.mozilla/firefox/*.default/extensions/chrome-gnome-shell@gnome.org.xpi ]; then
		wget -q https://addons.mozilla.org/firefox/downloads/file/4300298/gnome_shell_integration-12.xpi
		firefox gnome_shell_integration-12.xpi
		gum confirm "Have you clicked [Add] on firefox?" && true || return
		rm gnome_shell_integration-12.xpi
	fi
	if ! gnome-extensions list --enabled | grep -q dash-to-panel; then
		firefox https://extensions.gnome.org/extension/1160/dash-to-panel/
		gum confirm "Have you turned [ON] and clicked [Install]?" && true || return
	fi
	if ! gnome-extensions list --enabled | grep -q clipboard-indicator; then
		firefox https://extensions.gnome.org/extension/779/clipboard-indicator/
		gum confirm "Have you turned [ON] and clicked [Install]?" && true || return
	fi
}
# Configurating oh-my-zsh
install_oh_my_zsh() {
	install_command "zsh"
	install_command "git"
	sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
}
install_vscode_root() {
	# needs testing
	wget -q --show-progress -O vscode.deb "https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64"
	sudo apt install vscode.deb
	rm vscode.deb
}
install_vscode_rootless() {
	# needs testing
	wget -q --show-progress -O VSCode-linux-x64.tgz "https://code.visualstudio.com/sha/download?build=stable&os=linux-x64"
	tar -xzf VSCode-linux-x64.tgz
	rm VSCode-linux-x64.tgz
	mv VSCode-linux-x64 vscode
	mv vscode $VSCODE_PATH
	# if ! grep -q 'export PATH="$HOME/.local/bin:$PATH"' $HOME/.zshrc; then
	# 	echo 'export PATH="$HOME/.local/bin:$PATH"' >> $HOME/.zshrc
	# fi
	ln -s $VSCODE_PATH/vscode/bin/code $HOME/.local/bin/code
}
install_vscode_extensions() {
	code --install-extension mhutchie.git-graph
	code --install-extension ms-vscode.cpptools
	code --install-extension github.copilot
}
export CODESETTINGSFILE=$HOME/.config/Code/User/settings.json
# Configurating vscode
configure_vscode_settings() {
	if [ ! -f $CODESETTINGSFILE ]; then
		echo creating settings.json
		[ -d "$HOME/.config/Code/User" ] || mkdir -p "$HOME/.config/Code/User"
		cat << 'EOF' >> $CODESETTINGSFILE
{
	"github.copilot.editor.enableCodeActions": false,
	"extensions.ignoreRecommendations": true,
	"workbench.startupEditor": "none",
	"editor.detectIndentation": false,
	"editor.insertSpaces": false,
	"files.autoSave": "afterDelay"
}
EOF
	else
		echo settings.json already created
	fi
}
# Configurating alias
adding_alias() {
	if grep -q "My custom aliases" $HOME/.zshrc; then
		echo aliases already added
		return
	fi
	echo adding aliases to .zshrc
	cat << 'EOF' >> $HOME/.zshrc
#My custom aliases
alias fgit='find . -type d -name ".git"'
alias ccc='cc -Wall -Wextra -Werror *.c -lbsd -lreadline && ./a.out'
c() {
	if [ -z "$1" ]; then
		$VSCODE_PATH/vscode/bin/code .
	else
		$VSCODE_PATH/vscode/bin/code $1
	fi
}
gacp() {
	if [ -z "$1" ]; then
		git add . && git commit -m "Update" && git push
	else
		git add . && git commit -m "$1" && git push
	fi
}
export ZSH_COMPDUMP=$ZSH/cache/.zcompdump-$HOST
EOF
	sed -i 's/robbyrussell/simple/g' $HOME/.zshrc
}
setting_default_shell() {
	if [ "$SHELL" = '/usr/bin/zsh' ]; then
		if [ "$ROOT" = 'y' ]; then
			chsh -s $(which zsh)
		else
			echo exec /bin/zsh > $HOME/.bashrc
		fi
	else
		echo default shell is already $SHELL
	fi
}
exit_script() {
	cd - > /dev/null
	rmdir $TEMP_DIR
	exit
}
main() {
	while true; do
		# --no-limit implementation TO-DO
		REPLY=$(gum choose mode install_command install_gnome_extensions install_oh_my_zsh install_vscode_root install_vscode_rootless install_vscode_extensions configure_vscode_settings adding_alias setting_default_shell about exit_script)
		case $REPLY in
			mode)
				break
				;;
			about)
				open https://github.com/andrexandre/script > /dev/null
				;;
			*)
				$REPLY
		esac
	done
}
main
verify_installed_stuff
echo mode root: $ROOT
gum confirm "Do you want to continue?" && true || exit_script
install_gnome_extensions
install_oh_my_zsh
if [ "$ROOT" = 'y' ]; then
	install_vscode_root
else
	install_vscode_rootless
fi
install_vscode_extensions
configure_vscode_settings
adding_alias
setting_default_shell
exit_script
